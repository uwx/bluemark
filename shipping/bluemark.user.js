// ==UserScript==
// @name     bluemark
// @version  0.0.0
// @include  https://bsky.app/*
// @include  https://*.bsky.dev/*
// @grant    GM_setValue
// @grant    GM_getValue
// @grant    GM_registerMenuCommand
// @grant    GM_xmlhttpRequest
// ==/UserScript==

(function(){"use strict";function i(r){if(typeof r!="string"&&(r=String(r)),/[^\w#$%&'*+.^`|~-]/i.test(r))throw new TypeError("Invalid character in header field name");return r}function f(r){return typeof r!="string"&&(r=String(r)),r}class u{map={};constructor(e){this.map={},e instanceof u?e.forEach((t,o)=>{this.append(o,t)}):e&&Object.getOwnPropertyNames(e).forEach(t=>{this.append(t,e[t])})}append(e,t){e=i(e),t=f(t);const o=this.map[e];o===void 0?this.map[e]=[t]:o.push(t)}delete(e){delete this.map[i(e)]}get(e){const t=this.map[i(e)];return t?t[0]:null}getAll(e){return this.map[i(e)]||[]}has(e){return Object.prototype.hasOwnProperty.call(this.map,i(e))}set(e,t){this.map[i(e)]=[f(t)]}forEach(e,t){Object.getOwnPropertyNames(this.map).forEach(o=>{this.map[o].forEach(n=>{e.call(t,n,o,this)})})}*[Symbol.iterator](){for(const[e,t]of Object.entries(this.map))for(const o of t)yield[e,o]}}function c(r){return new Promise((e,t)=>{r.addEventListener("load",()=>{e(r.result)}),r.addEventListener("error",()=>{t(r.error)})})}function p(r){const e=new FileReader;return e.readAsArrayBuffer(r),c(e)}function m(r){const e=new FileReader;return e.readAsText(r),c(e)}const b=new TextEncoder,w=new TextDecoder;class y{_bodyUsed=!1;get bodyUsed(){return this._bodyUsed}blob(){if(this._bodyUsed)return Promise.reject(new TypeError("Body contents already read"));this._bodyUsed=!0;const e=this.body;if(typeof e=="string"||e instanceof ArrayBuffer)return Promise.resolve(new Blob([e]));if(e instanceof Blob)return Promise.resolve(e);if(e instanceof FormData)return Promise.reject(new TypeError("A multipart FormData body cannot be read as a blob"));if(e===void 0)return Promise.reject(new Error("No body is present"));throw new TypeError("Invalid body type")}arrayBuffer(){if(this._bodyUsed)return Promise.reject(new TypeError("Body contents already read"));this._bodyUsed=!0;const e=this.body;if(typeof e=="string")return Promise.resolve(b.encode(e));if(e instanceof ArrayBuffer)return Promise.resolve(e);if(e instanceof Blob)return Promise.resolve(p(e));if(e instanceof FormData)return Promise.reject(new TypeError("A multipart FormData body cannot be read as an arrayBuffer"));if(e===void 0)return Promise.reject(new Error("No body is present"));throw new TypeError("Invalid body type")}text(){if(this._bodyUsed)return Promise.reject(new TypeError("Body contents already read"));this._bodyUsed=!0;const e=this.body;if(typeof e=="string")return Promise.resolve(e);if(e instanceof ArrayBuffer)return Promise.resolve(w.decode(e));if(e instanceof Blob)return Promise.resolve(m(e));if(e instanceof FormData)return Promise.reject(new TypeError("A multipart FormData body cannot be read as text"));if(e===void 0)return Promise.reject(new Error("No body is present"));throw new TypeError("Invalid body type")}formData(){if(this._bodyUsed)return Promise.reject(new TypeError("Body contents already read"));this._bodyUsed=!0;const e=this.body;if(typeof e=="string")return Promise.reject(new TypeError("Unsupported: Cannot parse FormData from a string body"));if(e instanceof ArrayBuffer)return Promise.reject(new TypeError("Unsupported: Cannot parse FormData from an ArrayBuffer body"));if(e instanceof Blob)return Promise.reject(new TypeError("Unsupported: Cannot parse FormData from a Blob body"));if(e instanceof FormData)return Promise.resolve(e);if(e===void 0)return Promise.reject(new Error("No body is present"));throw new TypeError("Invalid body type")}json(){return this.text().then(JSON.parse)}}const E=new Set(["GET","HEAD","POST"]);function T(r){if(r=r.toUpperCase(),!E.has(r))throw new Error("Unsupported HTTP method for GM_xmlhttpRequest: "+r);return r}class l extends y{url;credentials;headers;method;mode;referrer;bodyStore;constructor(e,t){if(super(),t=t||{},this.url=e,this.credentials=t.credentials||"omit",this.headers=new u(t.headers),this.method=T(t.method||"GET"),this.mode=t.mode||null,this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&t.body)throw new TypeError("Body not allowed for GET or HEAD requests");this.bodyStore=t.body}get body(){return this.bodyStore}get bodyRaw(){return this.bodyStore}}function P(r){const e=new u;return r.trim().split(`
`).forEach(o=>{const n=o.trim().split(":"),s=n.shift().trim(),a=n.join(":").trim();e.append(s,a)}),e}class U extends y{constructor(e){super(),this.response=e,this.type="default",this.status=e.status,this.ok=this.status>=200&&this.status<300,this.statusText=e.statusText,this.headers=P(e.responseHeaders),this.url=g(e.finalUrl,e.responseHeaders,this.headers)||""}type;url;status;ok;statusText;headers;get body(){return this.response.response}text(){return this._bodyUsed?Promise.reject(new TypeError("Body contents already read")):(this._bodyUsed=!0,Promise.resolve(this.response.responseText))}}function g(r,e,t){return r||(/^X-Request-URL:/m.test(e)?t.get("X-Request-URL"):null)}function B(r,e){let t;if(r instanceof l?t=new l(r.url,e):t=new l(r,e),!["GET","HEAD","POST"].includes(t.method))throw new Error("Unsupported method for GM_xmlhttpRequest");return new Promise(function(o,n){const s={};s.method=t.method,s.responseType="arraybuffer",s.url=t.url,s.onload=a=>{const d=a.status;if(d<100||d>599){n(new TypeError("Network request failed: Status code "+d));return}o(new U(a))},s.onerror=()=>{n(new TypeError("Network request failed"))},s.headers={};for(const[a,d]of t.headers)s.headers[a]=d;typeof t.bodyRaw<"u"&&(s.data=t.bodyRaw),GM_xmlhttpRequest(s)})}console.log("hello world!");const h=new WeakSet;GM_registerMenuCommand("Set webhook",()=>{const r=prompt("Paste webhook URL here");r!=null&&(GM_setValue("webhookUrl",r),alert("URL set!"))}),setInterval(()=>{const r=[...document.querySelectorAll('[data-testid^="feedItem-"], [data-testid^="postThreadItem-"]')].map(e=>({element:e,buttons:e.querySelector('[aria-label="Open post options menu"]')?.parentElement.parentElement.parentElement,postLink:e.querySelector('[href^="/profile/"][href*="/post/"]')?.href}));for(const{element:e,buttons:t,postLink:o}of r){if(h.has(e))continue;h.add(e);const n=document.createElement("button");n.textContent="\u{1F4CC}",n.onclick=s=>{if(s.stopPropagation(),s.preventDefault(),console.log(`bookmarking ${o??document.location.href}`),!GM_getValue("webhookUrl")){alert("No webhook URL set!");return}B(GM_getValue("webhookUrl"),{method:"POST",body:JSON.stringify({content:x(o??document.location.href)}),headers:{"Content-Type":"application/json"}})},t&&t.append(n)}},250);function x(r){const e=new URL(r);return e.hostname="bskyx.app",e.toString()}})();
